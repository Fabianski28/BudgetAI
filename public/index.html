<div id="messages"></div>
<div id="input-container">
  <input type="text" id="userInput" placeholder="Tape ton message..." />
  <button id="sendBtn">Envoyer</button>
</div>

<script>
  const messagesDiv = document.getElementById("messages");
  const input = document.getElementById("userInput");
  const button = document.getElementById("sendBtn");

  let waiting = false;
  let userData = { step: 0 }; // suit l'étape côté serveur

  function addMessage(text, sender) {
    const div = document.createElement("div");
    div.className = `message ${sender}`;
    div.textContent = text;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  async function sendMessage() {
    if(waiting) return;
    const text = input.value.trim();
    if(!text) return;

    addMessage(text, "user");
    input.value = "";

    const loadingDiv = document.createElement("div");
    loadingDiv.className = "message bot loading";
    loadingDiv.textContent = "BudgeAI réfléchit...";
    messagesDiv.appendChild(loadingDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;

    waiting = true;
    try {
      const response = await fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: text, userData })
      });

      const data = await response.json();
      loadingDiv.remove();
      addMessage(data.reply, "bot");

      userData = data.userData; // mise à jour du step

    } catch(err) {
      loadingDiv.textContent = "Erreur serveur";
    } finally {
      waiting = false;
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
  }

  button.addEventListener("click", sendMessage);
  input.addEventListener("keydown", e => { if(e.key === "Enter") sendMessage(); });

  // Message de bienvenue
  addMessage("Bonjour ! Je suis BudgeAI. Je vais te poser une question à la fois pour t'aider à gérer ton budget.", "bot");
</script>
